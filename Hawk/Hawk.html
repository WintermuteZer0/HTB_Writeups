<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 7.8 (457454)"/><meta name="author" content="mcivor88@me.com"/><meta name="created" content="2018-08-08 17:59:07 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2019-01-26 07:48:34 +0000"/><title>Hawk</title></head><body><div><span style="font-size: 24px; font-weight: bold;">Foothold and User:</span></div><div><br/></div><div>Nmap scan shows following ports on host:</div><ul><li><div>21/ftp vsftp</div></li><li><div>22/tcp OpenSSH</div></li><li><div>80/tcp Apache HTTPd 2.4.29</div></li><li><div>8082 H2 Database Console</div></li></ul><div><br/></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">Scanned with vulnerable script shows several CVE’s for Apache HTTPd:</span></div><div><img src="Hawk.html.resources/Screen%20Shot%202018-08-08%20at%2019.15.16.png" height="872" width="1710"/><br/></div><div><br/></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">Rescan using http-enum script shows several interesting dirs on web server</span></div><div><img src="Hawk.html.resources/Screen%20Shot%202018-08-08%20at%2019.14.59.png" height="804" width="1210"/><br/></div><div><br/></div><div>Robots.txt entries:</div><div>Directories:</div><div>Disallow: /includes/</div><div>Disallow: /misc/</div><div>Disallow: /modules/</div><div>Disallow: /profiles/</div><div>Disallow: /scripts/</div><div>Disallow: /themes/</div><div><br/></div><div># Files</div><div>Disallow: /CHANGELOG.txt</div><div>Disallow: /cron.php</div><div>Disallow: /INSTALL.mysql.txt</div><div>Disallow: /INSTALL.pgsql.txt</div><div>Disallow: /INSTALL.sqlite.txt</div><div>Disallow: /install.php</div><div>Disallow: /INSTALL.txt</div><div>Disallow: /LICENSE.txt</div><div>Disallow: /MAINTAINERS.txt</div><div>Disallow: /update.php</div><div>Disallow: /UPGRADE.txt</div><div>Disallow: /xmlrpc.php</div><div># Paths (clean URLs)</div><div>Disallow: /admin/</div><div>Disallow: /comment/reply/</div><div>Disallow: /filter/tips/</div><div>Disallow: /node/add/</div><div>Disallow: /search/</div><div>Disallow: /user/register/</div><div>Disallow: /user/password/</div><div>Disallow: /user/login/</div><div>Disallow: /user/logout/</div><div># Paths (no clean URLs)</div><div>Disallow: /?q=admin/</div><div>Disallow: /?q=comment/reply/</div><div>Disallow: /?q=filter/tips/</div><div>Disallow: /?q=node/add/</div><div>Disallow: /?q=search/</div><div>Disallow: /?q=user/password/</div><div>Disallow: /?q=user/register/</div><div>Disallow: /?q=user/login/</div><div>Disallow: /?q=user/logout/</div><div><br/></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">CHANGELOG.txt shows that Apache server is running Drupal v 7.58 and therefore patched the latest security updates. No access here.</span></div><div> </div><div>FTP:</div><div>Using nmap ftp-anon script we can see that the FTP service allows remote anonymous connections:</div><div><img src="Hawk.html.resources/Screen%20Shot%202018-08-09%20at%2020.10.22.png" height="958" width="1308"/><br/></div><div> As we can see in the listings there is a hidden file name “<span style="background-color: rgb(255, 250, 165); font-style: italic;-evernote-highlight:true;">.drupal.txt.enc</span>”</div><div>We can download this file from the server for investigation.</div><div><br/></div><div>testing the file with the file command we get the following output:</div><div>“<span style="background-color: rgb(255, 250, 165); font-style: italic;-evernote-highlight:true;">drupal.txt.enc: openssl enc'd data with salted password, base64 encoded</span>"</div><div><br/></div><div>Using bruteforce-openssl-salted tool we can analyse the cipher text to try and find passwords</div><div>Using ciphers results in no finds</div><div>Using digests results in password candidate ‘friends’ on Sha256 digest type.</div><div><img src="Hawk.html.resources/Screen%20Shot%202018-08-10%20at%2010.51.37.png" height="768" width="2134"/><br/></div><div><br/></div><div>Using this password, attempted decryption using <span style="font-style: italic;">aes-256-cbc</span> mode cipher correctly decrypts the cipher text and the result as show above is displayed.</div><div><br/></div><div><br/></div><div>Using the credentials “Admin” and password “PencilKeyboardScanner123” from the file, we can log into the admin account on the Drupal instance.</div><div><br/></div><div><img src="Hawk.html.resources/Screen%20Shot%202018-08-10%20at%2011.49.49.png" height="1518" width="1688"/><br/></div><div><br/></div><div>From here given we are admin it looks like we can add content to the drupal installation, including php code pages.</div><div><br/></div><div>We can add a php simple reverse shell in a page, start a listener and trigger this by viewing the page.</div><div><img src="Hawk.html.resources/Screen%20Shot%202018-08-10%20at%2012.12.04.png" height="1300" width="2760"/><img src="Hawk.html.resources/Screen%20Shot%202018-08-10%20at%2012.12.29.png" height="514" width="1164"/><br/></div><div><img src="Hawk.html.resources/Screen%20Shot%202018-08-10%20at%2012.13.20.png" height="1382" width="1154"/><br/></div><div><br/></div><div>We can upgrade this shell to interactive shell using python:</div><div><span style="background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">python3 -c ‘import pty; pty.spawn(“/bin/bash”)</span><span style="font-weight: bold;">’</span></div><div><br/></div><div><span style="font-weight: bold;">We have the user flag for user Daniel, now we need to escalate prigs to get root on the box.</span></div><div><br/></div><div><span style="font-size: 24px;"><span style="font-size: 24px; font-weight: bold;">Privilege</span></span><span style="font-size: 24px; font-weight: bold;"> Escalation:</span></div><div>Looking through the processes running we see several running as root, however it stands out that the H2 instance identified earlier via external nmap scan is actually running as root</div><div><img src="Hawk.html.resources/Screen%20Shot%202018-08-12%20at%2011.46.31.png" height="140" width="2236"/><br/></div><div> </div><div>From the jar running in the process we can see the H2 version is 1.4.196 and use this to search for exploits.</div><div>Looking for H2 related exploits/CVE for this version turns up <a href="https://www.exploit-db.com/exploits/44422/">https://www.exploit-db.com/exploits/44422/</a> (<a href="https://mthbernardes.github.io/rce/2018/03/14/abusing-h2-database-alias.html">https://mthbernardes.github.io/rce/2018/03/14/abusing-h2-database-alias.html</a>)</div><div><br/></div><div>This allows shell on the H2 database and since this process is running as root, this should give us root privileges.</div><div><br/></div><div>Given we know the H2 console is running, we tried previously to access it remotely over the browser and received the following:</div><div> <img src="Hawk.html.resources/Screen%20Shot%202018-08-12%20at%2013.26.52.png" height="464" width="1296"/><br/></div><div>We can try to connect to this locally using curl (curl localhost:8082 ) and we receive the html login page for the H2 database console. This confirms that we should be able to run the python exploit locally from the box and gain root.</div><div><br/></div><div>First we must upload the python exploit to the box, this can be done using netcat:</div><ul><li><div><span style="font-weight: bold;">Run nc in lister mode on the remote host with output to file in writable location</span></div></li><ul><li><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">nc -l -p 1088 &gt; /tmp/h2_buster.py</span></div></li></ul><li><div><span style="font-weight: bold;">Run nc from local machine and input exploit file </span></div></li><ul><li><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">nc -w 3 10.10.10.102 &lt; h2_buster.py</span></div></li></ul></ul><div><img src="Hawk.html.resources/Screen%20Shot%202018-08-12%20at%2013.16.31.png" height="1024" width="2474"/><br/></div><div><br/></div><div><img src="Hawk.html.resources/Screen%20Shot%202018-08-13%20at%2022.59.24.png" height="238" width="1648"/><br/></div><div> </div><div>JDBC driver was wrongly set to jdbc:h2:~/test, </div><div>exploit worked with jdbc:h2:/data/db/test</div><div><br/></div><div><img src="Hawk.html.resources/Screen%20Shot%202018-08-13%20at%2023.09.43.png" height="1192" width="810"/><br/></div><div><br/></div></body></html>